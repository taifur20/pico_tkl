#include "quantum.h"
#include "soft_ssd1306.h"

/* ================ CONFIG ================ */
#define OLED_ADDR 0x3C
#define OLED_WIDTH 128
#define OLED_PAGES 4        // 128x32 display = 4 pages

#define SDA_PIN SOFT_I2C_SDA_PIN
#define SCL_PIN SOFT_I2C_SCL_PIN

/* ================ SOFT I2C ================ */
static inline void i2c_delay(void) { wait_us(5); }

static inline void sda_high(void) { setPinInputHigh(SDA_PIN); }
static inline void sda_low(void)  { setPinOutput(SDA_PIN); writePinLow(SDA_PIN); }
static inline void scl_high(void) { setPinInputHigh(SCL_PIN); }
static inline void scl_low(void)  { setPinOutput(SCL_PIN); writePinLow(SCL_PIN); }

static void soft_i2c_start(void) {
    sda_high(); scl_high(); i2c_delay();
    sda_low(); i2c_delay();
    scl_low();
}

static void soft_i2c_stop(void) {
    sda_low(); scl_high(); i2c_delay();
    sda_high(); i2c_delay();
}

static bool soft_i2c_write(uint8_t data) {
    for(uint8_t i=0;i<8;i++){
        (data & 0x80)? sda_high(): sda_low();
        i2c_delay();
        scl_high(); i2c_delay(); scl_low();
        data <<= 1;
    }
    sda_high(); i2c_delay();
    scl_high(); i2c_delay();
    bool ack = !readPin(SDA_PIN);
    scl_low();
    return ack;
}

/* ================ SSD1306 LOW LEVEL ================ */
static void ssd1306_cmd(uint8_t cmd) {
    soft_i2c_start();
    soft_i2c_write(OLED_ADDR << 1);
    soft_i2c_write(0x00);   // command
    soft_i2c_write(cmd);
    soft_i2c_stop();
}

static void ssd1306_data(uint8_t data) {
    soft_i2c_start();
    soft_i2c_write(OLED_ADDR << 1);
    soft_i2c_write(0x40);   // data
    soft_i2c_write(data);
    soft_i2c_stop();
}

/* ================ SSD1306 CORE ================ */
void oled_init_soft(void){
    wait_ms(100);   // power-up delay
    ssd1306_cmd(0xAE); // display off
    ssd1306_cmd(0x20); ssd1306_cmd(0x00);
    ssd1306_cmd(0xB0);
    ssd1306_cmd(0xC8);
    ssd1306_cmd(0x00); ssd1306_cmd(0x10);
    ssd1306_cmd(0x40);
    ssd1306_cmd(0x81); ssd1306_cmd(0x7F);
    ssd1306_cmd(0xA1);
    ssd1306_cmd(0xA6);
    ssd1306_cmd(0xA8); ssd1306_cmd(0x1F);
    ssd1306_cmd(0xA4);
    ssd1306_cmd(0xD3); ssd1306_cmd(0x00);
    ssd1306_cmd(0xD5); ssd1306_cmd(0x80);
    ssd1306_cmd(0xD9); ssd1306_cmd(0xF1);
    ssd1306_cmd(0xDA); ssd1306_cmd(0x02);
    ssd1306_cmd(0xDB); ssd1306_cmd(0x40);
    ssd1306_cmd(0x8D); ssd1306_cmd(0x14);
    ssd1306_cmd(0xAF); // display on
    ssd1306_clear();
}

static void ssd1306_set_page(uint8_t page){
    ssd1306_cmd(0xB0 | page);
}

static void ssd1306_set_column(uint8_t col){
    ssd1306_cmd(0x00 | (col & 0x0F));
    ssd1306_cmd(0x10 | (col >> 4));
}

/* ================ CLEAR / FILL ================ */
void ssd1306_fill(uint8_t value){
    for(uint8_t page=0;page<OLED_PAGES;page++){
        ssd1306_set_page(page);
        ssd1306_set_column(0);
        for(uint8_t col=0;col<OLED_WIDTH;col++)
            ssd1306_data(value);
    }
}

void ssd1306_clear(void){ ssd1306_fill(0x00); }

/* ================ FULL 5x7 ASCII FONT ================ */
static const uint8_t font5x7[122][5] = {
    // 0x20 - 0x2F
    {0x00,0x00,0x00,0x00,0x00}, // ' '
    {0x00,0x00,0x5F,0x00,0x00}, // !
    {0x00,0x07,0x00,0x07,0x00}, // "
    {0x14,0x7F,0x14,0x7F,0x14}, // #
    {0x24,0x2A,0x7F,0x2A,0x12}, // $
    {0x23,0x13,0x08,0x64,0x62}, // %
    {0x36,0x49,0x55,0x22,0x50}, // &
    {0x00,0x05,0x03,0x00,0x00}, // '
    {0x00,0x1C,0x22,0x41,0x00}, // (
    {0x00,0x41,0x22,0x1C,0x00}, // )
    {0x14,0x08,0x3E,0x08,0x14}, // *
    {0x08,0x08,0x3E,0x08,0x08}, // +
    {0x00,0x50,0x30,0x00,0x00}, // ,
    {0x08,0x08,0x08,0x08,0x08}, // -
    {0x00,0x60,0x60,0x00,0x00}, // .
    {0x20,0x10,0x08,0x04,0x02}, // /

    // 0x30 - 0x39 (0-9)
    {0x3E,0x51,0x49,0x45,0x3E}, // 0
    {0x00,0x42,0x7F,0x40,0x00}, // 1
    {0x42,0x61,0x51,0x49,0x46}, // 2
    {0x21,0x41,0x45,0x4B,0x31}, // 3
    {0x18,0x14,0x12,0x7F,0x10}, // 4
    {0x27,0x45,0x45,0x45,0x39}, // 5
    {0x3C,0x4A,0x49,0x49,0x30}, // 6
    {0x01,0x71,0x09,0x05,0x03}, // 7
    {0x36,0x49,0x49,0x49,0x36}, // 8
    {0x06,0x49,0x49,0x29,0x1E}, // 9

    // 0x3A - 0x40
    {0x00,0x36,0x36,0x00,0x00}, // :
    {0x00,0x56,0x36,0x00,0x00}, // ;
    {0x08,0x14,0x22,0x41,0x00}, // <
    {0x14,0x14,0x14,0x14,0x14}, // =
    {0x00,0x41,0x22,0x14,0x08}, // >
    {0x02,0x01,0x51,0x09,0x06}, // ?
    {0x32,0x49,0x79,0x41,0x3E}, // @

    // 0x41 - 0x5A (A-Z)
    {0x7E,0x11,0x11,0x11,0x7E}, // A
    {0x7F,0x49,0x49,0x49,0x36}, // B
    {0x3E,0x41,0x41,0x41,0x22}, // C
    {0x7F,0x41,0x41,0x22,0x1C}, // D
    {0x7F,0x49,0x49,0x49,0x41}, // E
    {0x7F,0x09,0x09,0x09,0x01}, // F
    {0x3E,0x41,0x49,0x49,0x7A}, // G
    {0x7F,0x08,0x08,0x08,0x7F}, // H
    {0x00,0x41,0x7F,0x41,0x00}, // I
    {0x20,0x40,0x41,0x3F,0x01}, // J
    {0x7F,0x08,0x14,0x22,0x41}, // K
    {0x7F,0x40,0x40,0x40,0x40}, // L
    {0x7F,0x02,0x04,0x02,0x7F}, // M
    {0x7F,0x04,0x08,0x10,0x7F}, // N
    {0x3E,0x41,0x41,0x41,0x3E}, // O
    {0x7F,0x09,0x09,0x09,0x06}, // P
    {0x3E,0x41,0x51,0x21,0x5E}, // Q
    {0x7F,0x09,0x19,0x29,0x46}, // R
    {0x46,0x49,0x49,0x49,0x31}, // S
    {0x01,0x01,0x7F,0x01,0x01}, // T
    {0x3F,0x40,0x40,0x40,0x3F}, // U
    {0x1F,0x20,0x40,0x20,0x1F}, // V
    {0x3F,0x40,0x38,0x40,0x3F}, // W
    {0x63,0x14,0x08,0x14,0x63}, // X
    {0x07,0x08,0x70,0x08,0x07}, // Y
    {0x61,0x51,0x49,0x45,0x43}, // Z

    // 0x5B - 0x60
    {0x00,0x7F,0x41,0x41,0x00}, // [
    {0x02,0x04,0x08,0x10,0x20}, // '\'
    {0x00,0x41,0x41,0x7F,0x00}, // ]
    {0x04,0x02,0x01,0x02,0x04}, // ^
    {0x40,0x40,0x40,0x40,0x40}, // _
    {0x00,0x01,0x02,0x04,0x00}, // `

    // 0x61 - 0x7A (a-z)
    {0x20,0x54,0x54,0x54,0x78}, // a
    {0x7F,0x48,0x44,0x44,0x38}, // b
    {0x38,0x44,0x44,0x44,0x20}, // c
    {0x38,0x44,0x44,0x48,0x7F}, // d
    {0x38,0x54,0x54,0x54,0x18}, // e
    {0x08,0x7E,0x09,0x01,0x02}, // f
    {0x0C,0x52,0x52,0x52,0x3E}, // g
    {0x7F,0x08,0x04,0x04,0x78}, // h
    {0x00,0x44,0x7D,0x40,0x00}, // i
    {0x20,0x40,0x44,0x3D,0x00}, // j
    {0x7F,0x10,0x28,0x44,0x00}, // k
    {0x00,0x41,0x7F,0x40,0x00}, // l
    {0x7C,0x04,0x18,0x04,0x78}, // m
    {0x7C,0x08,0x04,0x04,0x78}, // n
    {0x38,0x44,0x44,0x44,0x38}, // o
    {0x7C,0x14,0x14,0x14,0x08}, // p
    {0x08,0x14,0x14,0x18,0x7C}, // q
    {0x7C,0x08,0x04,0x04,0x08}, // r
    {0x48,0x54,0x54,0x54,0x20}, // s
    {0x04,0x3F,0x44,0x40,0x20}, // t
    {0x3C,0x40,0x40,0x20,0x7C}, // u
    {0x1C,0x20,0x40,0x20,0x1C}, // v
    {0x3C,0x40,0x30,0x40,0x3C}, // w
    {0x44,0x28,0x10,0x28,0x44}, // x
    {0x0C,0x50,0x50,0x50,0x3C}, // y
    {0x44,0x64,0x54,0x4C,0x44}  // z
};

/* ================ PRINT CHAR / STRING ================ */
static void ssd1306_char(char c){
    if(c < 32 || c > 127) c = '?';
    const uint8_t *bitmap = font5x7[c-32];
    for(uint8_t i=0;i<5;i++)
        ssd1306_data(bitmap[i]);
    ssd1306_data(0x00); // spacing
}

void ssd1306_print(const char *str, uint8_t page, uint8_t col){
    ssd1306_set_page(page);
    ssd1306_set_column(col);
    while(*str)
        ssd1306_char(*str++);
}

/* ================ PRINT DOUBLE SIZE CHAR / STRING ================ */
// Double-size font printing: 10x14
static void ssd1306_char_double(char c, uint8_t page, uint8_t col){
    if(c < 32 || c > 127) c = '?';
    const uint8_t *bitmap = font5x7[c - 32];

    // Each character: 5x7 â†’ 10x14
    // page = 0 or 1 for top/bottom line
    for(uint8_t col_idx = 0; col_idx < 5; col_idx++){
        uint8_t b = bitmap[col_idx];
        // Expand each column into 2 columns (horizontal doubling)
        for(uint8_t h=0; h<2; h++){
            uint8_t upper = 0;
            uint8_t lower = 0;
            // Expand each bit into 2 rows (vertical doubling)
            for(uint8_t row=0; row<7; row++){
                if(b & (1 << row)){
                    if(row < 4) upper |= (1 << (row*2)) | (1 << (row*2+1));
                    else        lower |= (1 << ((row-4)*2)) | (1 << ((row-4)*2+1));
                }
            }
            // Write upper 8 bits to page
            ssd1306_set_page(page);
            ssd1306_set_column(col);
            ssd1306_data(upper);
            col++;

            // Write lower 6 bits to next page
            ssd1306_set_page(page + 1);
            ssd1306_set_column(col-1);
            ssd1306_data(lower);
        }
    }
    // spacing column
    col++;
    ssd1306_set_column(col);
    ssd1306_data(0x00);
}

void ssd1306_print_double(const char *str, uint8_t page, uint8_t col){
    while(*str){
        ssd1306_char_double(*str++, page, col);
        col += 10; // next char position
        if(col > OLED_WIDTH - 10) break; // prevent overflow
    }
}

void oled_print_line(uint8_t line, const char *str){
    uint8_t page = line * 2; // each double-size line occupies 2 pages
    uint8_t col = 0;
    while(*str){
        ssd1306_char_double(*str++, page, col);
        col += 10; // 10 pixels wide per char
        if(col > OLED_WIDTH - 10) break;
    }
}